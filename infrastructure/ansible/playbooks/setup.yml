---
# =============================================================================
# PLAYBOOK: setup.yml
# Complete Memocards infrastructure setup on VPS
# =============================================================================
#
# This playbook performs initial installation of the entire infrastructure:
# - Basic system configuration (common)
# - Docker installation (docker)
# - Nginx installation and SSL configuration (nginx)
# - Application deployment (app)
#
# Usage:
#   ansible-playbook -i ../inventory/hosts.yml setup.yml --ask-vault-pass
#
# Or with dry run (check without changes):
#   ansible-playbook -i ../inventory/hosts.yml setup.yml --ask-vault-pass --check
# =============================================================================

- name: Deploy Memocards Infrastructure on VPS
  hosts: vps
  become: true
  gather_facts: true

  vars_files:
    - ../inventory/group_vars/all.yml
    - ../secrets.yml

  pre_tasks:
    - name: Display deployment information
      ansible.builtin.debug:
        msg: |
          â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
          â•‘     Memocards Infrastructure Deployment Starting...        â•‘
          â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

          ğŸ¯ Target: {{ inventory_hostname }}
          ğŸ§ Starting deployment...
          â±ï¸  This will take approximately 10-15 minutes...
      tags: [always]
      when: ansible_facts is defined

    - name: Update package cache
      ansible.builtin.apt:
        update_cache: true
        cache_valid_time: 3600
      tags: [always]

  roles:
    - role: common
      tags: [common, setup]

    - role: docker
      tags: [docker, setup]

    - role: nginx
      tags: [nginx, setup]

    - role: monitoring
      tags: [monitoring, setup]

    - role: app
      tags: [app, setup]

  post_tasks:
    - name: Display deployment summary
      ansible.builtin.debug:
        msg: |
          â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
          â•‘    ğŸ‰ Memocards Infrastructure Deployed Successfully!     â•‘
          â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

          ğŸ“¦ Components:
          âœ… System configured (firewall, swap, directories)
          âœ… Docker Engine installed and running
          âœ… Nginx installed with SSL
          âœ… Infrastructure deployed (Prometheus, Loki, Promtail, Grafana)
          âœ… Application deployed and healthy
          âœ… PostgreSQL database running
          âœ… Auto-restart enabled (Docker restart policy)

          ğŸŒ Access:
          - URL: https://{{ domain }}
          - Health: https://{{ domain }}/actuator/health

          ğŸ“‹ Next Steps:
          1. Test application: curl -I https://{{ domain }}
          2. Check logs: docker logs -f memocards-app-prod
          3. For updates: ansible-playbook -i ../inventory/hosts.yml deploy.yml --ask-vault-pass

          ğŸ“š Documentation: ../README.md
      tags: [always]

    - name: Save deployment timestamp
      ansible.builtin.copy:
        content: |
          Deployment completed: {{ ansible_date_time.iso8601 }}
          Deployed by: {{ ansible_user_id }}@{{ ansible_hostname }}
          Version: {{ app_image }}
        dest: "{{ app_deploy_path }}/.deployment_info"
        mode: "0644"
      tags: [always]
