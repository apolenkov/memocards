---
# =============================================================================
# Monitoring Role - Deploy Infrastructure (Prometheus, Loki, Promtail, Grafana)
# =============================================================================

- name: Create infrastructure directories on server
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    mode: "0755"
  loop:
    - "{{ app_deploy_path }}/infrastructure/grafana"
    - "{{ app_deploy_path }}/infrastructure/grafana/config"
    - "{{ app_deploy_path }}/infrastructure/grafana/dashboards"
    - "{{ app_deploy_path }}/infrastructure/grafana/provisioning"
    - "{{ app_deploy_path }}/infrastructure/grafana/provisioning/datasources"
    - "{{ app_deploy_path }}/infrastructure/prometheus"
    - "{{ app_deploy_path }}/infrastructure/promtail"
    - "{{ app_deploy_path }}/infrastructure/traefik"
    - "{{ app_deploy_path }}/infrastructure/traefik/dynamic"
    - "{{ app_deploy_path }}/infrastructure/loki"
  tags: [monitoring, config]

- name: Copy Grafana configuration files
  ansible.builtin.copy:
    src: "{{ playbook_dir }}/../../../infrastructure/grafana/{{ item }}"
    dest: "{{ app_deploy_path }}/infrastructure/grafana/{{ item }}"
    mode: "0644"
    force: true
  loop:
    - "config/grafana.ini"
    - "dashboards/dashboard-memocards.json"
    - "provisioning/dashboards.yml"
  tags: [monitoring, config]

- name: Create Grafana datasources from template
  ansible.builtin.template:
    src: "{{ playbook_dir }}/../roles/monitoring/templates/grafana-datasources.yml.j2"
    dest: "{{ app_deploy_path }}/infrastructure/grafana/provisioning/datasources/prometheus.yml"
    mode: "0644"
    force: true
  tags: [monitoring, config]

- name: Copy Prometheus configuration
  ansible.builtin.copy:
    src: "{{ playbook_dir }}/../../../infrastructure/prometheus/prometheus.yml"
    dest: "{{ app_deploy_path }}/infrastructure/prometheus/prometheus.yml"
    mode: "0644"
    force: true
  tags: [monitoring, config]

- name: Copy Promtail configuration file
  ansible.builtin.copy:
    src: "{{ playbook_dir }}/../../../infrastructure/promtail/promtail.yml"
    dest: "{{ app_deploy_path }}/infrastructure/promtail/promtail.yml"
    mode: "0644"
    force: true
  tags: [monitoring, config]

- name: Copy Traefik static configuration files
  ansible.builtin.copy:
    src: "{{ playbook_dir }}/../../../infrastructure/traefik/{{ item }}"
    dest: "{{ app_deploy_path }}/infrastructure/traefik/{{ item }}"
    mode: "0644"
    force: true
  loop:
    - "traefik.yml"
  tags: [monitoring, config]

- name: Generate Traefik dashboard auth from template
  ansible.builtin.template:
    src: "{{ playbook_dir }}/../roles/monitoring/templates/dashboard-auth.yml.j2"
    dest: "{{ app_deploy_path }}/infrastructure/traefik/dynamic/dashboard-auth.yml"
    mode: "0644"
    force: true
  tags: [monitoring, config]

- name: Copy Loki configuration file
  ansible.builtin.copy:
    src: "{{ playbook_dir }}/../../../infrastructure/loki/loki.yml"
    dest: "{{ app_deploy_path }}/infrastructure/loki/loki.yml"
    mode: "0644"
    force: true
  tags: [monitoring, config]

- name: Copy Docker Compose configuration (infrastructure)
  ansible.builtin.copy:
    src: "{{ playbook_dir }}/../../../docker-compose.infrastructure.yml"
    dest: "{{ app_deploy_path }}/docker-compose.infrastructure.yml"
    mode: "0644"
  tags: [monitoring, config]

- name: Start infrastructure services
  community.docker.docker_compose_v2:
    project_src: "{{ app_deploy_path }}"
    files:
      - docker-compose.infrastructure.yml
    state: present
    recreate: always
  register: monitoring_infrastructure_compose_result
  tags: [monitoring, deploy]

- name: Wait for Grafana to be ready (after deployment)
  ansible.builtin.shell: |
    for i in {1..30}; do
      if docker exec {{ grafana_container_name | default('memocards-grafana') }} curl -f http://localhost:3000/api/health 2>/dev/null; then
        exit 0
      fi
      sleep 2
    done
    exit 1
  register: monitoring_grafana_health
  changed_when: false
  failed_when: false
  tags: [monitoring, verify]

- name: Display monitoring status
  ansible.builtin.debug:
    msg: |
      âœ… Infrastructure deployed:

      ğŸ“Š Prometheus: localhost:9090
      ğŸ“‹ Loki: localhost:3100
      ğŸ“ Promtail: running
      ğŸ“ˆ Grafana: localhost:3000

      ğŸ”— Access via SSH tunnel:
      - ssh -L 9090:localhost:9090 root@{{ ansible_host }}
      - ssh -L 3000:localhost:3000 root@{{ ansible_host }}
  tags: [monitoring]
