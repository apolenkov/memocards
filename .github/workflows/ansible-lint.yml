name: Ansible Lint and Syntax Check

on:
  push:
    branches: [ main, master, develop, security-performance-fixes ]
    paths:
      - 'ansible/**'
      - '.github/workflows/ansible-lint.yml'
  pull_request:
    branches: [ main, master, develop ]
    paths:
      - 'ansible/**'

jobs:
  ansible-lint:
    name: Ansible Syntax Check
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'
          cache: 'pip'
      
      - name: Install Ansible and dependencies
        run: |
          cd ansible
          pip install -r requirements.txt
      
      - name: Create vault password file
        run: |
          # Create vault password file if secret is provided
          if [ -n "${{ secrets.ANSIBLE_VAULT_PASSWORD }}" ]; then
            echo "${{ secrets.ANSIBLE_VAULT_PASSWORD }}" > /tmp/vault_pass.txt
            chmod 600 /tmp/vault_pass.txt
            echo "VAULT_FILE=/tmp/vault_pass.txt" >> $GITHUB_ENV
          else
            echo "::warning::ANSIBLE_VAULT_PASSWORD secret is not set. Skipping vault decryption."
            echo "VAULT_FILE=" >> $GITHUB_ENV
          fi
      
      - name: Run ansible-playbook syntax check
        run: |
          cd ansible
          for playbook in playbooks/*.yml; do
            echo "Checking $playbook..."
            if [ -n "$VAULT_FILE" ]; then
              ansible-playbook --syntax-check "$playbook" --vault-password-file "$VAULT_FILE"
            else
              # Try without vault password (will fail if vault is required)
              ansible-playbook --syntax-check "$playbook" || {
                echo "::warning::Syntax check failed. This might be due to missing ANSIBLE_VAULT_PASSWORD secret."
                exit 1
              }
            fi
          done
      
      - name: Cleanup vault password file
        if: always()
        run: |
          if [ -f /tmp/vault_pass.txt ]; then
            shred -u /tmp/vault_pass.txt || rm -f /tmp/vault_pass.txt
          fi
      
      - name: Run ansible-lint (optional)
        continue-on-error: true
        run: |
          cd ansible
          if command -v ansible-lint &> /dev/null; then
            for playbook in playbooks/*.yml; do
              echo "Linting $playbook..."
              ansible-lint "$playbook" || true
            done
          else
            echo "::notice::ansible-lint not available, skipping"
          fi
