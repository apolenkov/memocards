---
name: Create Release

# IMPORTANT: This workflow requires a Personal Access Token (PAT) to trigger other workflows!
# 
# Why? When using the default GITHUB_TOKEN, pushed tags/commits do NOT trigger other workflows
# (security measure to prevent recursive workflow runs). To trigger main.yml and deploy.yml after
# creating a release tag, we need to use a PAT instead.
#
# Setup Instructions:
# 1. Create a Fine-grained PAT: https://github.com/settings/tokens?type=beta
#    - Token name: MEMOCARDS_RELEASE_PAT
#    - Repository access: Only apolenkov/memocards
#    - Permissions: Contents (Read and write)
# 2. Add to repository secrets: https://github.com/apolenkov/memocards/settings/secrets/actions
#    - Name: PAT_GITHUB_TOKEN
#    - Value: ghp_xxxxx (your PAT)
#
# Reference: https://docs.github.com/en/actions/security-guides/automatic-token-authentication
#
# VERSION MANAGEMENT:
# - Project version is automatically managed by JGitver plugin (build.gradle.kts)
# - JGitver reads version from Git tags (e.g., v1.0.0 â†’ version = "1.0.0")
# - This workflow creates Git tag â†’ JGitver reads it â†’ version is set automatically
# - NO manual version update in build.gradle.kts needed!
# - See: .github/VERSION_MANAGEMENT_BEST_PRACTICES.md

# Manual trigger - auto-calculates version and generates changelog
on:
  workflow_dispatch:
    inputs:
      version_type:
        description: 'Version bump type (or specify custom version)'
        required: true
        type: choice
        options:
          - auto      # Auto-detect from commits (feat/fix/BREAKING)
          - major     # 1.0.0 â†’ 2.0.0 (breaking changes)
          - minor     # 1.0.0 â†’ 1.1.0 (new features)
          - patch     # 1.0.0 â†’ 1.0.1 (bug fixes)
          - custom    # Specify exact version below
        default: 'auto'
      custom_version:
        description: 'Custom version (only if version_type=custom, e.g., v1.5.0)'
        required: false
        type: string
        default: ''
      additional_notes:
        description: 'Additional release notes (optional, appended to auto-generated changelog)'
        required: false
        type: string
        default: ''

permissions:
  contents: write  # Required to create tags and releases

jobs:
  create-release:
    name: Create Release with Auto Versioning
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        with:
          fetch-depth: 0  # Full history for versioning and changelog
          token: ${{ secrets.PAT_GITHUB_TOKEN }}  # PAT to trigger other workflows

      - name: Get latest tag
        id: get_latest_tag
        run: |
          LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
          echo "latest_tag=$LATEST_TAG" >> $GITHUB_OUTPUT
          echo "ğŸ“‹ Latest tag: $LATEST_TAG"

      - name: Calculate next version
        id: calculate_version
        run: |
          LATEST_TAG="${{ steps.get_latest_tag.outputs.latest_tag }}"
          VERSION_TYPE="${{ inputs.version_type }}"
          CUSTOM_VERSION="${{ inputs.custom_version }}"
          
          # Parse current version
          VERSION=${LATEST_TAG#v}
          MAJOR=$(echo $VERSION | cut -d. -f1)
          MINOR=$(echo $VERSION | cut -d. -f2)
          PATCH=$(echo $VERSION | cut -d. -f3)
          
          echo "ğŸ“Š Current version: $MAJOR.$MINOR.$PATCH"
          
          # Determine bump type
          if [ "$VERSION_TYPE" = "custom" ]; then
            if [ -z "$CUSTOM_VERSION" ]; then
              echo "âŒ ERROR: custom_version is required when version_type=custom"
              exit 1
            fi
            NEW_VERSION="$CUSTOM_VERSION"
            if [[ ! "$NEW_VERSION" =~ ^v ]]; then
              NEW_VERSION="v$NEW_VERSION"
            fi
            BUMP_TYPE="custom"
          elif [ "$VERSION_TYPE" = "auto" ]; then
            # Auto-detect from commit messages since last tag
            COMMITS=$(git log $LATEST_TAG..HEAD --pretty=format:"%s")
            
            if echo "$COMMITS" | grep -qE "(^|: )BREAKING CHANGE|^[a-z]+\!:"; then
              # Major version bump (breaking change)
              MAJOR=$((MAJOR + 1))
              MINOR=0
              PATCH=0
              BUMP_TYPE="major (breaking changes detected)"
            elif echo "$COMMITS" | grep -qE "^feat(\(|:)"; then
              # Minor version bump (new features)
              MINOR=$((MINOR + 1))
              PATCH=0
              BUMP_TYPE="minor (new features detected)"
            else
              # Patch version bump (fixes or chores)
              PATCH=$((PATCH + 1))
              BUMP_TYPE="patch (fixes/improvements detected)"
            fi
            NEW_VERSION="v$MAJOR.$MINOR.$PATCH"
          else
            # Explicit bump type
            if [ "$VERSION_TYPE" = "major" ]; then
              MAJOR=$((MAJOR + 1))
              MINOR=0
              PATCH=0
            elif [ "$VERSION_TYPE" = "minor" ]; then
              MINOR=$((MINOR + 1))
              PATCH=0
            elif [ "$VERSION_TYPE" = "patch" ]; then
              PATCH=$((PATCH + 1))
            fi
            NEW_VERSION="v$MAJOR.$MINOR.$PATCH"
            BUMP_TYPE="$VERSION_TYPE (manual)"
          fi
          
          echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "bump_type=$BUMP_TYPE" >> $GITHUB_OUTPUT
          echo "âœ… Next version: $NEW_VERSION ($BUMP_TYPE)"

      - name: Check if tag already exists
        run: |
          NEW_VERSION="${{ steps.calculate_version.outputs.new_version }}"
          
          if git rev-parse "$NEW_VERSION" >/dev/null 2>&1; then
            echo "âŒ ERROR: Tag $NEW_VERSION already exists!"
            echo "   Please choose a different version or delete the existing tag."
            exit 1
          fi
          
          echo "âœ… Tag $NEW_VERSION does not exist, safe to create"

      - name: Generate changelog
        id: generate_changelog
        run: |
          LATEST_TAG="${{ steps.get_latest_tag.outputs.latest_tag }}"
          NEW_VERSION="${{ steps.calculate_version.outputs.new_version }}"
          BUMP_TYPE="${{ steps.calculate_version.outputs.bump_type }}"
          
          echo "## ğŸ‰ Release $NEW_VERSION" > changelog.md
          echo "" >> changelog.md
          echo "**Type:** $BUMP_TYPE" >> changelog.md
          echo "" >> changelog.md
          
          # Check if this is the first release
          if git rev-parse "$LATEST_TAG" >/dev/null 2>&1; then
            # Get commits since last tag
            COMMITS=$(git log $LATEST_TAG..HEAD --pretty=format:"%s" 2>/dev/null || echo "")
            
            if [ -n "$COMMITS" ]; then
              echo "### ğŸ“‹ Changes since $LATEST_TAG" >> changelog.md
              echo "" >> changelog.md
              
              # Categorize commits
              FEATURES=$(echo "$COMMITS" | grep -E "^feat(\(|:)" || true)
              FIXES=$(echo "$COMMITS" | grep -E "^fix(\(|:)" || true)
              BREAKING=$(echo "$COMMITS" | grep -E "(^|: )BREAKING CHANGE|^[a-z]+\!:" || true)
              OTHERS=$(echo "$COMMITS" | grep -vE "^(feat|fix)(\(|:)" || true)
              
              # Breaking changes first
              if [ -n "$BREAKING" ]; then
                echo "#### âš ï¸ BREAKING CHANGES" >> changelog.md
                echo "" >> changelog.md
                echo "$BREAKING" | while read -r line; do
                  HASH=$(git log --all --pretty=format:"%h %s" | grep "$line" | head -1 | cut -d' ' -f1)
                  echo "- $line (\`$HASH\`)" >> changelog.md
                done
                echo "" >> changelog.md
              fi
              
              # Features
              if [ -n "$FEATURES" ]; then
                echo "#### âœ¨ Features" >> changelog.md
                echo "" >> changelog.md
                echo "$FEATURES" | while read -r line; do
                  HASH=$(git log --all --pretty=format:"%h %s" | grep "$line" | head -1 | cut -d' ' -f1)
                  echo "- $line (\`$HASH\`)" >> changelog.md
                done
                echo "" >> changelog.md
              fi
              
              # Bug fixes
              if [ -n "$FIXES" ]; then
                echo "#### ğŸ› Bug Fixes" >> changelog.md
                echo "" >> changelog.md
                echo "$FIXES" | while read -r line; do
                  HASH=$(git log --all --pretty=format:"%h %s" | grep "$line" | head -1 | cut -d' ' -f1)
                  echo "- $line (\`$HASH\`)" >> changelog.md
                done
                echo "" >> changelog.md
              fi
              
              # Other changes
              if [ -n "$OTHERS" ]; then
                echo "#### ğŸ”§ Other Changes" >> changelog.md
                echo "" >> changelog.md
                echo "$OTHERS" | while read -r line; do
                  HASH=$(git log --all --pretty=format:"%h %s" | grep "$line" | head -1 | cut -d' ' -f1)
                  echo "- $line (\`$HASH\`)" >> changelog.md
                done
                echo "" >> changelog.md
              fi
            fi
          else
            echo "### ğŸ‰ Initial Release" >> changelog.md
            echo "" >> changelog.md
            echo "First production release of Memocards application." >> changelog.md
            echo "" >> changelog.md
          fi
          
          # Add additional notes if provided
          ADDITIONAL="${{ inputs.additional_notes }}"
          if [ -n "$ADDITIONAL" ]; then
            echo "### ğŸ“ Additional Notes" >> changelog.md
            echo "" >> changelog.md
            echo "$ADDITIONAL" >> changelog.md
            echo "" >> changelog.md
          fi
          
          # Add deployment info
          echo "---" >> changelog.md
          echo "" >> changelog.md
          echo "**Deployment:**" >> changelog.md
          echo "- ğŸ—ï¸ Built with GitHub Actions" >> changelog.md
          echo "- ğŸ³ Docker image: \`ghcr.io/${{ github.repository }}:${NEW_VERSION#v}\`" >> changelog.md
          echo "- ğŸš€ Auto-deployed to production" >> changelog.md
          
          cat changelog.md
          echo "âœ… Changelog generated"

      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Create and push tag
        run: |
          NEW_VERSION="${{ steps.calculate_version.outputs.new_version }}"
          
          echo "ğŸ“‹ Creating tag: $NEW_VERSION on current HEAD"
          echo "   Current commit: $(git rev-parse --short HEAD)"
          git tag -a "$NEW_VERSION" -m "Release $NEW_VERSION"
          
          echo "ğŸš€ Pushing tag to remote..."
          git push origin "$NEW_VERSION"
          
          echo "âœ… Tag pushed successfully!"
          echo ""
          echo "This will automatically trigger:"
          echo "  â€¢ Main Branch Deployment (build + test + Docker push)"
          echo "  â€¢ Deploy to VPS (ansible + deploy)"

      - name: Create GitHub Release
        env:
          GH_TOKEN: ${{ secrets.PAT_GITHUB_TOKEN }}
        run: |
          NEW_VERSION="${{ steps.calculate_version.outputs.new_version }}"
          
          echo "ğŸ“¦ Creating GitHub Release..."
          gh release create "$NEW_VERSION" \
            --title "$NEW_VERSION" \
            --notes-file changelog.md \
            --latest
          
          echo "âœ… GitHub Release created!"
          echo "   View at: https://github.com/${{ github.repository }}/releases/tag/$NEW_VERSION"

      - name: Deployment summary
        run: |
          NEW_VERSION="${{ steps.calculate_version.outputs.new_version }}"
          BUMP_TYPE="${{ steps.calculate_version.outputs.bump_type }}"
          LATEST_TAG="${{ steps.get_latest_tag.outputs.latest_tag }}"
          
          echo "## ğŸ‰ Release $NEW_VERSION Created" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Previous version:** \`$LATEST_TAG\`" >> $GITHUB_STEP_SUMMARY
          echo "**New version:** \`$NEW_VERSION\`" >> $GITHUB_STEP_SUMMARY
          echo "**Bump type:** $BUMP_TYPE" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“‹ Changelog" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          cat changelog.md >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸš€ Automated Workflows Triggered" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "The following workflows will run automatically in parallel:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "1. ğŸ”„ **[Main Branch Deployment](https://github.com/${{ github.repository }}/actions/workflows/main.yml)**" >> $GITHUB_STEP_SUMMARY
          echo "   - Runs tests and quality checks" >> $GITHUB_STEP_SUMMARY
          echo "   - Builds and pushes Docker image" >> $GITHUB_STEP_SUMMARY
          echo "   - Duration: ~15 minutes" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "2. ğŸš€ **[Deploy to VPS](https://github.com/${{ github.repository }}/actions/workflows/deploy.yml)**" >> $GITHUB_STEP_SUMMARY
          echo "   - Waits for Docker image to be ready" >> $GITHUB_STEP_SUMMARY
          echo "   - Deploys to production via Ansible" >> $GITHUB_STEP_SUMMARY
          echo "   - Duration: ~25-30 minutes (includes wait time)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ”— Links" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- [ğŸ“¦ Release Page](https://github.com/${{ github.repository }}/releases/tag/$NEW_VERSION)" >> $GITHUB_STEP_SUMMARY
          echo "- [ğŸ”„ Workflows](https://github.com/${{ github.repository }}/actions)" >> $GITHUB_STEP_SUMMARY
          echo "- [ğŸ·ï¸ All Tags](https://github.com/${{ github.repository }}/tags)" >> $GITHUB_STEP_SUMMARY
          
          echo ""
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘      ğŸ‰ Release $NEW_VERSION Created!                      â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "ğŸ“‹ Previous: $LATEST_TAG â†’ New: $NEW_VERSION"
          echo "ğŸ·ï¸  Bump type: $BUMP_TYPE"
          echo "ğŸ“ Changelog: Auto-generated from commits"
          echo ""
          echo "ğŸ”„ Triggered workflows:"
          echo "  â€¢ main.yml - Build & Test (~15 min)"
          echo "  â€¢ deploy.yml - Deploy to VPS (~25-30 min total)"
          echo ""
          echo "View release: https://github.com/${{ github.repository }}/releases/tag/$NEW_VERSION"

