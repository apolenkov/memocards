---
# =============================================================================
# PLAYBOOK: deploy.yml
# Ğ‘Ñ‹ÑÑ‚Ñ€Ğ¾Ğµ Ñ€Ğ°Ğ·Ğ²ĞµÑ€Ñ‚Ñ‹Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ½Ğ¾Ğ²Ğ¾Ğ¹ Ğ²ĞµÑ€ÑĞ¸Ğ¸ Memocards Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ñ
# =============================================================================
#
# Ğ­Ñ‚Ğ¾Ñ‚ playbook Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½ÑĞµÑ‚ Ğ±Ñ‹ÑÑ‚Ñ€Ñ‹Ğ¹ Ğ´ĞµĞ¿Ğ»Ğ¾Ğ¹ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ñ:
# - Pull latest Docker image
# - Recreate containers
# - Health check
#
# Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ:
#   ansible-playbook -i ../inventory/hosts.yml deploy.yml --ask-vault-pass
#
# Ğ¡ Ğ¾Ğ¿Ñ€ĞµĞ´ĞµĞ»ĞµĞ½Ğ½Ğ¾Ğ¹ Ğ²ĞµÑ€ÑĞ¸ĞµĞ¹:
#   ansible-playbook -i ../inventory/hosts.yml deploy.yml --ask-vault-pass \
#     --extra-vars "app_image=ghcr.io/apolenkov/memocards:0.1"
#
# Ğ¡ ĞºĞ¾Ğ½ĞºÑ€ĞµÑ‚Ğ½Ñ‹Ğ¼ ĞºĞ¾Ğ¼Ğ¼Ğ¸Ñ‚Ğ¾Ğ¼ (Ğ¸Ğ· CI/CD):
#   ansible-playbook -i ../inventory/hosts.yml deploy.yml --ask-vault-pass \
#     --extra-vars "app_image=ghcr.io/apolenkov/memocards:abc1234"
# =============================================================================

- name: Deploy Memocards Application Update
  hosts: vps
  become: yes
  gather_facts: no
  
  vars_files:
    - ../secrets.yml
  
  tasks:
    - name: Display deployment information
      debug:
        msg: |
          â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
          â•‘         Memocards Application Deployment Starting...      â•‘
          â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          
          ğŸ¯ Target: {{ inventory_hostname }}
          ğŸ³ Image: {{ app_image }}
          ğŸŒ Domain: {{ domain }}
      tags: [always]

    - name: Pull latest application image
      community.docker.docker_image_pull:
        name: "{{ app_image }}"
      register: pull_result
      tags: [deploy]

    - name: Stop application containers
      community.docker.docker_compose_v2:
        project_src: "{{ app_deploy_path }}"
        files: docker-compose.yml
        state: stopped
      tags: [deploy]

    - name: Start application services
      community.docker.docker_compose_v2:
        project_src: "{{ app_deploy_path }}"
        files: docker-compose.yml
        state: present
        recreate: always
        pull: always
      register: compose_result
      tags: [deploy]

    - name: Wait for PostgreSQL to be healthy
      shell: docker inspect --format='{% raw %}{{.State.Health.Status}}{% endraw %}' memocards-postgres-prod
      register: postgres_health
      retries: 30
      delay: 2
      until: postgres_health.stdout == "healthy"
      changed_when: false
      tags: [deploy, health]

    - name: Wait for application to be ready
      uri:
        url: "http://localhost:{{ app_port }}/actuator/health"
        method: GET
        status_code: 200
      retries: 60
      delay: 5
      register: health_check
      until: health_check.status == 200
      tags: [deploy, health]

    - name: Get application version info
      uri:
        url: "http://localhost:{{ app_port }}/actuator/info"
        method: GET
        return_content: yes
      register: app_info
      failed_when: false
      tags: [deploy, verify]

    - name: Display deployment status
      debug:
        msg: |
          â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
          â•‘      ğŸš€ Application Deployed Successfully!                â•‘
          â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          
          âœ… Status:
          - Image pulled: {{ app_image }}
          - Containers recreated: âœ…
          - Health check: {{ 'PASSED âœ…' if health_check.status == 200 else 'FAILED âŒ' }}
          - PostgreSQL: {{ postgres_health.stdout }}
          
          ğŸŒ Access:
          - URL: https://{{ domain }}
          - Health: https://{{ domain }}/actuator/health
          
          ğŸ“‹ Verify:
          - Check application: curl https://{{ domain }}
          - View logs: docker logs -f memocards-app-prod
          - Check metrics: curl http://localhost:{{ app_port }}/actuator/metrics
      tags: [always]

    - name: Update deployment timestamp
      copy:
        content: |
          Last deployment: {{ lookup('pipe', 'date -u +%Y-%m-%dT%H:%M:%SZ') }}
          Deployed by: Ansible
          Image: {{ app_image }}
        dest: "{{ app_deploy_path }}/.last_deployment"
        mode: '0644'
      tags: [always]

