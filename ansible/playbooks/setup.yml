---
# =============================================================================
# PLAYBOOK: setup.yml
# Полная установка инфраструктуры Memocards на VPS
# =============================================================================
#
# Этот playbook выполняет первичную установку всей инфраструктуры:
# - Базовая настройка системы (common)
# - Установка Docker (docker)
# - Установка и настройка Nginx с SSL (nginx)
# - Развертывание приложения (app)
#
# Использование:
#   ansible-playbook -i ../inventory/hosts.yml setup.yml --ask-vault-pass
#
# Или с сухим запуском (проверка без изменений):
#   ansible-playbook -i ../inventory/hosts.yml setup.yml --ask-vault-pass --check
# =============================================================================

- name: Deploy Memocards Infrastructure on VPS
  hosts: vps
  become: yes
  gather_facts: yes

  vars_files:
    - ../inventory/group_vars/all.yml
    - ../secrets.yml

  pre_tasks:
    - name: Display deployment information
      debug:
        msg: |
          ╔════════════════════════════════════════════════════════════╗
          ║     Memocards Infrastructure Deployment Starting...        ║
          ╚════════════════════════════════════════════════════════════╝

          🎯 Target: {{ inventory_hostname }}
          🐧 Starting deployment...
          ⏱️  This will take approximately 10-15 minutes...
      tags: [always]
      when: ansible_facts is defined

    - name: Update package cache
      apt:
        update_cache: yes
        cache_valid_time: 3600
      tags: [always]

  roles:
    - role: common
      tags: [common, setup]

    - role: docker
      tags: [docker, setup]

    - role: nginx
      tags: [nginx, setup]

    - role: app
      tags: [app, setup]

  post_tasks:
    - name: Display deployment summary
      debug:
        msg: |
          ╔════════════════════════════════════════════════════════════╗
          ║    🎉 Memocards Infrastructure Deployed Successfully!     ║
          ╚════════════════════════════════════════════════════════════╝

          📦 Components:
          ✅ System configured (firewall, swap, directories)
          ✅ Docker Engine installed and running
          ✅ Nginx installed with SSL
          ✅ Application deployed and healthy
          ✅ PostgreSQL database running
          ✅ Auto-restart enabled (Docker restart policy)

          🌐 Access:
          - URL: https://{{ domain }}
          - Health: https://{{ domain }}/actuator/health

          📋 Next Steps:
          1. Test application: curl -I https://{{ domain }}
          2. Check logs: docker logs -f memocards-app-prod
          3. For updates: ansible-playbook -i ../inventory/hosts.yml deploy.yml --ask-vault-pass

          📚 Documentation: ../README.md
      tags: [always]

    - name: Save deployment timestamp
      copy:
        content: |
          Deployment completed: {{ ansible_date_time.iso8601 }}
          Deployed by: {{ ansible_user_id }}@{{ ansible_hostname }}
          Version: {{ app_image }}
        dest: "{{ app_deploy_path }}/.deployment_info"
        mode: "0644"
      tags: [always]
