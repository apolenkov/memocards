---
# =============================================================================
# PLAYBOOK: setup.yml
# ĞŸĞ¾Ğ»Ğ½Ğ°Ñ ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ° Ğ¸Ğ½Ñ„Ñ€Ğ°ÑÑ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ñ‹ Memocards Ğ½Ğ° VPS
# =============================================================================
#
# Ğ­Ñ‚Ğ¾Ñ‚ playbook Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½ÑĞµÑ‚ Ğ¿ĞµÑ€Ğ²Ğ¸Ñ‡Ğ½ÑƒÑ ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºÑƒ Ğ²ÑĞµĞ¹ Ğ¸Ğ½Ñ„Ñ€Ğ°ÑÑ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ñ‹:
# - Ğ‘Ğ°Ğ·Ğ¾Ğ²Ğ°Ñ Ğ½Ğ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ° ÑĞ¸ÑÑ‚ĞµĞ¼Ñ‹ (common)
# - Ğ£ÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ° Docker (docker)
# - Ğ£ÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ° Ğ¸ Ğ½Ğ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ° Nginx Ñ SSL (nginx)
# - Ğ Ğ°Ğ·Ğ²ĞµÑ€Ñ‚Ñ‹Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ñ (app)
#
# Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ:
#   ansible-playbook -i ../inventory/hosts.yml setup.yml --ask-vault-pass
#
# Ğ˜Ğ»Ğ¸ Ñ ÑÑƒÑ…Ğ¸Ğ¼ Ğ·Ğ°Ğ¿ÑƒÑĞºĞ¾Ğ¼ (Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ±ĞµĞ· Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ğ¹):
#   ansible-playbook -i ../inventory/hosts.yml setup.yml --ask-vault-pass --check
# =============================================================================

- name: Deploy Memocards Infrastructure on VPS
  hosts: vps
  become: yes
  gather_facts: yes

  vars_files:
    - ../inventory/group_vars/all.yml
    - ../secrets.yml

  pre_tasks:
    - name: Display deployment information
      debug:
        msg: |
          â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
          â•‘     Memocards Infrastructure Deployment Starting...        â•‘
          â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

          ğŸ¯ Target: {{ inventory_hostname }}
          ğŸ§ Starting deployment...
          â±ï¸  This will take approximately 10-15 minutes...
      tags: [always]
      when: ansible_facts is defined

    - name: Update package cache
      apt:
        update_cache: yes
        cache_valid_time: 3600
      tags: [always]

  roles:
    - role: common
      tags: [common, setup]

    - role: docker
      tags: [docker, setup]

    - role: nginx
      tags: [nginx, setup]

    - role: app
      tags: [app, setup]

  post_tasks:
    - name: Display deployment summary
      debug:
        msg: |
          â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
          â•‘    ğŸ‰ Memocards Infrastructure Deployed Successfully!     â•‘
          â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

          ğŸ“¦ Components:
          âœ… System configured (firewall, swap, directories)
          âœ… Docker Engine installed and running
          âœ… Nginx installed with SSL
          âœ… Application deployed and healthy
          âœ… PostgreSQL database running
          âœ… Auto-restart enabled (Docker restart policy)

          ğŸŒ Access:
          - URL: https://{{ domain }}
          - Health: https://{{ domain }}/actuator/health

          ğŸ“‹ Next Steps:
          1. Test application: curl -I https://{{ domain }}
          2. Check logs: docker logs -f memocards-app-prod
          3. For updates: ansible-playbook -i ../inventory/hosts.yml deploy.yml --ask-vault-pass

          ğŸ“š Documentation: ../README.md
      tags: [always]

    - name: Save deployment timestamp
      copy:
        content: |
          Deployment completed: {{ ansible_date_time.iso8601 }}
          Deployed by: {{ ansible_user_id }}@{{ ansible_hostname }}
          Version: {{ app_image }}
        dest: "{{ app_deploy_path }}/.deployment_info"
        mode: "0644"
      tags: [always]
