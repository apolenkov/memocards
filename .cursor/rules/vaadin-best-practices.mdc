---
alwaysApply: true
autoFix: true
version: "1.0.0"
tags: ["vaadin24", "ui", "frontend", "lumo"]
---

# VAADIN 24+ BEST PRACTICES

## ğŸ—ï¸ ARCHITECTURE

### Patterns
- **Composite**: `extends Composite<T> + initContent()` for reusable components
- **Builder**: Fluent API for complex UI
- **Factory**: Centralized creation (`ButtonHelper.createPrimary()`)

### âŒ NEVER
- Direct inheritance from `Div/VerticalLayout` instead of `Composite<T>`
- Component in static/final field without cleanup

## ğŸ”„ LIFECYCLE

### Order (critical!)
1. **Constructor** â†’ data only, NO UI logic
2. **@PostConstruct** â†’ Spring DI ready, `getTranslation()` works
3. **onAttach** â†’ register listeners, component in DOM
4. **onDetach** â†’ MANDATORY `Registration.remove()`

### Decision Tree
- Non-Spring â†’ `Composite<T>` + `initContent()`
- Spring @Route â†’ `@PostConstruct`
- Listeners â†’ `onAttach()` + cleanup in `onDetach()`

### âŒ NEVER
- `getTranslation()` in Spring View constructor â†’ NPE
- Listeners without `Registration.remove()` â†’ memory leak
- Forget `super.onDetach(e)`

## ğŸ§  MEMORY

### âœ… ALWAYS
```java
private Registration reg;
@Override protected void onAttach(AttachEvent e) {
    super.onAttach(e);
    reg = broadcaster.register(this::update);
}
@Override protected void onDetach(DetachEvent e) {
    if (reg != null) reg.remove(); // CRITICAL!
    super.onDetach(e);
}
```

### State Management
- âœ… Only IDs in fields (`Long userId`)
- âŒ Collections/objects in session (`List<User> all`)

## âš¡ PERFORMANCE

### âœ… ALWAYS
- **Lazy Loading**: `grid.setItems(query -> service.findAll(PageRequest...))`
- **Virtual Scrolling**: `grid.setPageSize(50)`
- **Flat Hierarchy**: max 3 nesting levels

### âŒ NEVER
- `grid.setItems(service.findAll())` for > 100 items
- `for(Item i : items) layout.add(new Card(i))` â†’ thousands of divs in DOM
- Unnecessary wrapper layouts

## ğŸ¨ UI/UX

### âœ… ALWAYS
- **Lumo Tokens**: `var(--lumo-space-m)`, `var(--lumo-primary-color)`
- **Factory Pattern**: `ButtonHelper.createPrimary(text, listener)`
- **Responsive**: mobile-first, CSS Grid/Flexbox

### âŒ NEVER
- Hardcoded styles: `"16px"`, `"#333"`, `"bold"`
- Duplicate component creation code

## ğŸŒ i18n

### âœ… ALWAYS
- UI: `getTranslation("key")` directly
- Non-UI: accepts ready `String text`

### âŒ NEVER
- Hardcoded strings in UI: `new H1("Users")`
- `UnaryOperator<String> translationProvider` pattern

## ğŸ”’ SECURITY

### âœ… ALWAYS
- Server-side validation (+ client-side optional)
- `Binder` with validators for forms
- CSRF enabled (don't disable!)

### âŒ NEVER
- Client-side validation only
- `security.csrf().disable()`
- XSS via `new Html(userInput)` without sanitization

## ğŸ“Š DATA BINDING

### Forms
```java
Binder<User> binder = new Binder<>(User.class);
binder.forField(field)
    .asRequired("Required")
    .withValidator(new EmailValidator("Invalid"))
    .bind(User::getEmail, User::setEmail);
```

### Navigation
```java
// âœ… Type-safe
@Route("user/:id")
class UserView implements HasUrlParameter<Long> { }
UI.getCurrent().navigate(UserView.class, 123L);

// âŒ Strings
UI.getCurrent().navigate("user?id=123");
```

## ğŸš€ PUSH

### âœ… ALWAYS
```java
@Push @Route("chat")
class ChatView extends VerticalLayout {
    void onMessage(String msg) {
        getUI().ifPresent(ui -> ui.access(() -> {
            messages.add(msg);
            ui.push();
        }));
    }
}
```

### âŒ NEVER
```java
new Thread(() -> {
    UI.getCurrent().access(...); // NPE! UI.getCurrent() = null in thread
}).start();

// âœ… Save UI reference
UI ui = UI.getCurrent();
new Thread(() -> ui.access(() -> {})).start();
```

## ğŸ”§ ERROR HANDLING

```java
VaadinSession.getCurrent().setErrorHandler(event -> {
    LOGGER.error("Error", event.getThrowable());
    Notification.show(getTranslation("error.generic"));
});
```

## âš ï¸ CRITICAL ANTIPATTERNS

1. **UI.getCurrent() in thread** â†’ NPE (save UI before thread)
2. **getTranslation() in constructor** â†’ NPE (use @PostConstruct)
3. **Listeners without cleanup** â†’ memory leak (`onDetach()` mandatory)
4. **Component in final field** â†’ memory leak (create locally)
5. **Loop in listener** â†’ stack overflow (`button.click()` in `addClickListener`)
6. **grid.setItems(all)** â†’ OOM (use lazy loading)

## âœ… CHECKLIST

Every component:
- [ ] `Composite<T>` (reusable) or extends for views
- [ ] `@PostConstruct` (Spring) or `initContent()` (non-Spring)
- [ ] `onDetach()` + `Registration.remove()` if has listeners
- [ ] `getTranslation()` for all strings
- [ ] Server-side validation
- [ ] Lazy loading if > 100 items
- [ ] Lumo tokens (no hardcode)
- [ ] `UI.access()` for threads
- [ ] Minimum server-side state
- [ ] Factory/Helper for repetitions

## ğŸ¯ AUTO-FIX

For Vaadin component:
1. Check pattern (Composite/Builder/Factory)
2. Check lifecycle (Constructorâ†’@PostConstructâ†’onAttachâ†’onDetach)
3. Check cleanup (Registration.remove in onDetach)
4. Check i18n (getTranslation for strings)
5. Check performance (lazy loading)
6. Check memory leaks
7. Apply Lumo tokens
8. Add JavaDoc
