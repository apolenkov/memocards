---
alwaysApply: true
autoFix: true
version: "2.0.0"
---

# VAADIN 24+ BEST PRACTICES

## PATTERNS
Composite<T> + initContent() | Builder | Factory

## LIFECYCLE (CRITICAL!)
1. Constructor → data ONLY (NO UI)
2. @PostConstruct (Spring) or initContent() → getTranslation() safe
3. onAttach → register listeners
4. onDetach → Registration.remove() MANDATORY

## MEMORY [CRITICAL]
- onDetach: `if(reg!=null) reg.remove()` + `super.onDetach(e)`
- Fields: IDs only (NO collections/objects)

## PERFORMANCE
- Lazy: `grid.setItems(query→service.find(PageRequest))`
- Virtual scroll: `grid.setPageSize(50)`
- Flat hierarchy: max 3 nesting

## UI/UX
- Lumo tokens: `var(--lumo-*)`
- Factory: `ButtonHelper.create*()`
- Responsive: mobile-first

## i18n
- UI: `getTranslation("key")` directly
- [BAD] Hardcoded strings → NPE in constructor

## SECURITY
- Server validation + Binder
- CSRF enabled
- [BAD] Client-only validation

## @UIScope (Spring)

**Use when [OK]:**
- @Component + Reused across @Route views + Needs UI.getCurrent()
- @Lazy for @UIScope injection into @Component
- LocaleChangeObserver: only with @UIScope WITHOUT page.reload()

**Don't use [BAD]:**
- @Route views (created by Vaadin)
- Dialogs (short lifecycle)
- Reusable Components (created in View)
- Stateless Services (singleton sufficient)

```java
@Component @UIScope
public class TopMenu extends HorizontalLayout implements LocaleChangeObserver {
    @Override
    public void localeChange(LocaleChangeEvent e) { refreshMenu(); }
}

@Component
public class SomeService {
    // [OK] @Lazy for @UIScope dependency
    public SomeService(@Lazy TopMenu menu) { this.menu = menu; }
}
```

## @Lazy (Spring Dependency Injection)

**What is @Lazy:**
- Delays bean creation until first access
- Solves scope conflicts (@Component → @UIScope)
- Prevents circular dependencies
- Optimizes performance for heavy resources

**Use @Lazy when [OK]:**
- @Component injecting @UIScope beans
- Circular dependencies (A → B → A)
- Heavy resources not always needed
- Conditional bean creation

**Don't use @Lazy when [BAD]:**
- Regular @Component → @Component dependencies
- Always-needed beans (adds overhead)
- Performance-critical paths
- Simple, lightweight dependencies

## CRITICAL ANTIPATTERNS [BAD]
1. getTranslation() in constructor → NPE
2. Listeners without cleanup → memory leak
3. UI.getCurrent() in thread → NPE (save UI ref first)
4. Component in final field → memory leak
5. grid.setItems(all) for >100 → OOM (use lazy)
6. Forget super.onDetach(e)
7. @UIScope without @Lazy injection → scope conflict
8. @Lazy for regular @Component dependencies → unnecessary overhead
9. **@Component + extends Dialog** → singleton Dialog, state tree corruption
10. **removeAll() + add(sameComponent)** → component reuse, memory leak
11. **UI.getCurrent().add(this) in @Component** → state tree corruption
12. **Component field in singleton** → component reuse across UI sessions

## PUSH
@Push + save UI ref: `UI ui=UI.getCurrent(); thread(()->ui.access(()->...))`

## DIALOG PATTERN [OK]

**Factory Pattern** (для Dialog в @Component):
```java
@Component
public class MyDialogFactory {
    public void openDialog() {
        Dialog dialog = new Dialog(); // ✅ Новый каждый раз!
        UI.getCurrent().add(dialog);
        dialog.open();
    }
}
```

**Direct Creation** (в @Route views):
```java
public class MyView extends VerticalLayout {
    private void showDialog() {
        MyDialog dialog = new MyDialog(...); // ✅ Новый каждый раз!
        dialog.open();
    }
}
```

**[BAD] Singleton Dialog**:
```java
@Component
public class MyDialog extends Dialog { } // ❌ ПЛОХО! State tree corruption!
```

## COMPONENT REUSE [BAD]

**NEVER reuse components**:
```java
private Button myButton = new Button();
layout.removeAll();
layout.add(myButton); // ❌ Component reuse!
```

**DO: Use setVisible() or recreate**:
```java
// Option 1: Visibility
myButton.setVisible(false); // ✅ Скрыть
myButton.setVisible(true);  // ✅ Показать

// Option 2: Recreate
layout.removeAll();
Button newButton = new Button(); // ✅ Новый компонент!
layout.add(newButton);
```

## CHECKLIST
- [ ] Composite<T> (reusable) or extends for @Route views
- [ ] @PostConstruct or initContent()
- [ ] onDetach + Registration.remove()
- [ ] getTranslation() for all strings
- [ ] Server validation
- [ ] Lazy loading if >100 items
- [ ] Lumo tokens (no hardcode)
- [ ] @Lazy for @UIScope dependencies
- [ ] No @Lazy for regular @Component dependencies
- [ ] No @Component + extends Dialog
- [ ] No removeAll() + add(sameComponent)
- [ ] Dialog created via new each time
